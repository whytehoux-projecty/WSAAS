// Aurum Vault Database Schema
// This is your Prisma schema file for the luxury banking platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Admin User Management
model AdminUser {
  id              String    @id @default(cuid())
  email           String    @unique
  password        String
  firstName       String    @map("first_name")
  lastName        String    @map("last_name")
  role            String    @default("ADMIN") // ADMIN, SUPER_ADMIN, COMPLIANCE_OFFICER
  permissions     String?   // Comma-separated permission strings
  status          String    @default("ACTIVE") // ACTIVE, SUSPENDED, INACTIVE
  lastLoginAt     DateTime? @map("last_login_at")
  loginAttempts   Int       @default(0) @map("login_attempts")
  lockedUntil     DateTime? @map("locked_until")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  createdBy       String?   @map("created_by")

  // Relations
  auditLogs             AuditLog[]
  sessions              AdminSession[]
  portalStatusChanges   PortalStatus[]
  portalStatusAuditLogs PortalStatusAudit[]
  paymentVerifications  PaymentVerification[]

  @@map("admin_users")
}

// Admin Session Management
model AdminSession {
  id             String    @id @default(cuid())
  adminUserId    String    @map("admin_user_id")
  sessionId      String    @unique @map("session_id")
  ipAddress      String    @map("ip_address")
  userAgent      String    @map("user_agent")
  isActive       Boolean   @default(true) @map("is_active")
  expiresAt      DateTime  @map("expires_at")
  lastActivityAt DateTime  @default(now()) @map("last_activity_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  adminUser      AdminUser @relation(fields: [adminUserId], references: [id], onDelete: Cascade)

  @@map("admin_sessions")
}

// User Management
model User {
  id              String    @id @default(cuid())
  email           String    @unique
  password        String
  firstName       String    @map("first_name")
  lastName        String    @map("last_name")
  phone           String?
  dateOfBirth     DateTime  @map("date_of_birth")
  status          String @default("ACTIVE")
  kycStatus       String @default("PENDING") @map("kyc_status")
  riskLevel       String @default("LOW") @map("risk_level")
  tier            String @default("BASIC")
  loginAttempts   Int       @default(0) @map("login_attempts")
  lockedUntil     DateTime? @map("locked_until")
  lastLoginAt     DateTime? @map("last_login_at")
  twoFactorEnabled Boolean  @default(false) @map("two_factor_enabled")
  twoFactorSecret  String?  @map("two_factor_secret")
  twoFactorBackupCodes String? @map("two_factor_backup_codes")
  kycNotes        String?   @map("kyc_notes")
  suspensionReason String?  @map("suspension_reason")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  accounts        Account[]
  kycDocuments    KycDocument[]
  auditLogs       AuditLog[]
  sessions        UserSession[]
  address         Address?
  beneficiaries   Beneficiary[]
  billPayees      BillPayee[]
  loans           Loan[]

  @@map("users")
}

// User Address
model Address {
  id        String @id @default(cuid())
  userId    String @unique @map("user_id")
  street    String
  city      String
  state     String
  zipCode   String @map("zip_code")
  country   String @default("US")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("addresses")
}

// Account Management
model Account {
  id                String        @id @default(cuid())
  userId            String        @map("user_id")
  accountNumber     String        @unique @map("account_number")
  accountType       String   @map("account_type")
  currency          String        @default("USD")
  balance           Decimal       @default(0.00)
  status            String @default("ACTIVE")
  interestRate      Decimal       @default(0.0) @map("interest_rate")
  dailyLimit        Decimal       @default(5000.00) @map("daily_limit")
  monthlyLimit      Decimal       @default(50000.00) @map("monthly_limit")
  overdraftLimit    Decimal       @default(0.00) @map("overdraft_limit")
  lastTransactionAt DateTime?     @map("last_transaction_at")
  closedAt          DateTime?     @map("closed_at")
  closureReason     String?       @map("closure_reason")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  // Relations
  user              User @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions      Transaction[]
  wireTransfers     WireTransfer[]

  statements        Statement[]
  cards             Card[]
  loans             Loan[]

  @@map("accounts")
}

// Transaction Processing
model Transaction {
  id              String            @id @default(cuid())
  accountId       String            @map("account_id")
  type            String
  amount          Decimal           
  currency        String            @default("USD")
  status          String @default("PENDING")
  category        String @default("UNCATEGORIZED")
  description     String
  reference       String            @unique
  metadata        String?
  processedAt     DateTime?         @map("processed_at")
  failureReason   String?           @map("failure_reason")
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  // Relations
  account         Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  wireTransfer    WireTransfer?
  paymentVerification PaymentVerification?

  @@map("transactions")
}

// Wire Transfer Management
model WireTransfer {
  id                     String              @id @default(cuid())
  transactionId          String              @unique @map("transaction_id")
  senderAccountId        String              @map("sender_account_id")
  recipientName          String              @map("recipient_name")
  recipientBankName      String              @map("recipient_bank_name")
  recipientBankSwift     String?             @map("recipient_bank_swift")
  recipientAccountNumber String              @map("recipient_account_number")
  recipientAddress       String?             @map("recipient_address")
  purposeCode            String?             @map("purpose_code")
  regulatoryInfo         String?               @map("regulatory_info")
  complianceStatus       String    @default("PENDING") @map("compliance_status")
  fee                    Decimal             @default(25.00)
  exchangeRate           Decimal             @default(1.0) @map("exchange_rate")
  estimatedArrival       DateTime?           @map("estimated_arrival")
  approvedBy             String?             @map("approved_by")
  approvedAt             DateTime?           @map("approved_at")
  rejectionReason        String?             @map("rejection_reason")
  createdAt              DateTime            @default(now()) @map("created_at")
  updatedAt              DateTime            @updatedAt @map("updated_at")

  // Relations
  transaction            Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  senderAccount          Account @relation(fields: [senderAccountId], references: [id])

  @@map("wire_transfers")
}

// Foreign Exchange Rates
model FxRate {
  id             String    @id @default(cuid())
  baseCurrency   String    @map("base_currency")
  targetCurrency String    @map("target_currency")
  rate           Decimal   
  spread         Decimal   @default(0.0025)
  effectiveFrom  DateTime  @map("effective_from")
  effectiveTo    DateTime? @map("effective_to")
  provider       String?
  createdAt      DateTime  @default(now()) @map("created_at")

  @@unique([baseCurrency, targetCurrency, effectiveFrom])
  @@map("fx_rates")
}

// KYC Document Management
model KycDocument {
  id                 String             @id @default(cuid())
  userId             String             @map("user_id")
  documentType       String             @map("document_type")
  fileName           String             @map("file_name")
  filePath           String             @map("file_path")
  fileSize           Int                @map("file_size")
  mimeType           String             @map("mime_type")
  fileHash           String             @map("file_hash")
  verificationStatus String @default("PENDING") @map("verification_status")
  verifiedBy         String?            @map("verified_by")
  verifiedAt         DateTime?          @map("verified_at")
  rejectionReason    String?            @map("rejection_reason")
  expiresAt          DateTime?          @map("expires_at")
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")

  // Relations
  user               User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("kyc_documents")
}

// Audit Trail
model AuditLog {
  id           String     @id @default(cuid())
  userId       String?    @map("user_id")
  adminUserId  String?    @map("admin_user_id")
  action       String
  entityType   String     @map("entity_type")
  entityId     String?    @map("entity_id")
  details      String?
  ipAddress    String?    @map("ip_address")
  userAgent    String?    @map("user_agent")
  sessionId    String?    @map("session_id")
  severity     String     @default("INFO") // INFO, WARNING, ERROR, CRITICAL
  category     String?    // AUTHENTICATION, TRANSACTION, KYC, ADMIN, SYSTEM
  createdAt    DateTime   @default(now()) @map("created_at")

  // Relations
  user         User?      @relation(fields: [userId], references: [id], onDelete: SetNull)
  adminUser    AdminUser? @relation(fields: [adminUserId], references: [id], onDelete: SetNull)

  @@map("audit_logs")
}

// User Session Management
model UserSession {
  id             String   @id @default(cuid())
  userId         String   @map("user_id")
  sessionId      String   @unique @map("session_id")
  ipAddress      String   @map("ip_address")
  userAgent      String   @map("user_agent")
  isActive       Boolean  @default(true) @map("is_active")
  expiresAt      DateTime @map("expires_at")
  lastActivityAt DateTime @default(now()) @map("last_activity_at")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  user           User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_sessions")
}

// Portal Status Management
model PortalStatus {
  id                          String    @id @default(cuid())
  status                      String    @default("online") // online, offline, maintenance, scheduled_downtime
  message                     String?
  nextScheduledMaintenance    DateTime? @map("next_scheduled_maintenance")
  scheduledMaintenanceMessage String?   @map("scheduled_maintenance_message")
  updatedAt                   DateTime  @updatedAt @map("updated_at")
  updatedBy                   String?   @map("updated_by")

  // Relations
  adminUser                   AdminUser? @relation(fields: [updatedBy], references: [id], onDelete: SetNull)
  auditLogs                   PortalStatusAudit[]

  @@map("portal_status")
}

// Portal Status Change Audit Log
model PortalStatusAudit {
  id              String       @id @default(cuid())
  portalStatusId  String       @map("portal_status_id")
  previousStatus  String       @map("previous_status")
  newStatus       String       @map("new_status")
  message         String?
  changedBy       String       @map("changed_by")
  changedAt       DateTime     @default(now()) @map("changed_at")
  reason          String?
  ipAddress       String?      @map("ip_address")
  userAgent       String?      @map("user_agent")

  // Relations
  adminUser       AdminUser    @relation(fields: [changedBy], references: [id], onDelete: Cascade)
  portalStatus    PortalStatus @relation(fields: [portalStatusId], references: [id], onDelete: Cascade)

  @@map("portal_status_audit")
}

// Contact Form Submissions
model ContactSubmission {
  id        String   @id @default(cuid())
  name      String
  email     String
  phone     String?
  subject   String
  message   String
  status    String   @default("NEW") // NEW, IN_PROGRESS, RESOLVED, ARCHIVED
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("contact_submissions")
}

// Account Application
model AccountApplication {
  id              String   @id @default(cuid())
  applicationType String   @map("application_type") // PERSONAL, BUSINESS, WEALTH
  firstName       String   @map("first_name")
  lastName        String   @map("last_name")
  email           String
  phone           String
  dateOfBirth     DateTime @map("date_of_birth")
  ssn             String?
  address         String
  city            String
  state           String
  zipCode         String   @map("zip_code")
  employmentStatus String  @map("employment_status")
  annualIncome    Decimal  @map("annual_income")
  sourceOfFunds   String   @map("source_of_funds")
  status          String   @default("PENDING") // PENDING, APPROVED, REJECTED, REVIEW
  reviewedBy      String?  @map("reviewed_by")
  reviewedAt      DateTime? @map("reviewed_at")
  rejectionReason String?  @map("rejection_reason")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("account_applications")
}

// Beneficiary Management
model Beneficiary {
  id              String   @id @default(cuid())
  userId          String   @map("user_id")
  name            String
  accountNumber   String   @map("account_number")
  bankName        String   @map("bank_name")
  swiftCode       String?  @map("swift_code")
  nickname        String?
  email           String?
  isInternal      Boolean  @default(false) @map("is_internal")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("beneficiaries")
}

// Statements
model Statement {
  id              String   @id @default(cuid())
  accountId       String   @map("account_id")
  statementType   String   @map("statement_type") // MONTHLY, QUARTERLY, ANNUAL
  periodStart     DateTime @map("period_start")
  periodEnd       DateTime @map("period_end")
  filePath        String   @map("file_path")
  fileSize        Int      @map("file_size")
  generatedAt     DateTime @default(now()) @map("generated_at")

  // Relations
  account         Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@map("statements")
}

// Card Management
model Card {
  id              String   @id @default(cuid())
  accountId       String   @map("account_id")
  cardNumber      String   @unique @map("card_number")
  cardType        String   @map("card_type") // DEBIT, CREDIT
  network         String   @default("VISA")
  expiryDate      DateTime @map("expiry_date")
  cvv             String
  status          String   @default("ACTIVE") // ACTIVE, FROZEN, BLOCKED
  pin             String?
  dailyLimit      Decimal  @default(2000.00) @map("daily_limit")
  monthlyLimit    Decimal  @default(20000.00) @map("monthly_limit")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  account         Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@map("cards")
}

// Bill Payments
model BillPayee {
  id            String   @id @default(cuid())
  userId        String   @map("user_id")
  name          String
  accountNumber String   @map("account_number")
  category      String   // UTILITIES, INTERNET, INSURANCE
  createdAt     DateTime @default(now()) @map("created_at")
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("bill_payees")
}

// System Configuration
model SystemConfig {
  key         String   @id
  value       String
  description String?
  updatedAt   DateTime @updatedAt @map("updated_at")
  updatedBy   String?  @map("updated_by")

  @@map("system_config")
}

// Payment Verification
model PaymentVerification {
  id                 String      @id @default(cuid())
  transactionId      String      @unique @map("transaction_id")
  documentPath       String      @map("document_path")
  documentType       String      @map("document_type") // PASSPORT, ID_CARD, etc
  status             String      @default("PENDING") // PENDING, APPROVED, REJECTED
  adminNotes         String?     @map("admin_notes")
  reviewedBy         String?     @map("reviewed_by")
  reviewedAt         DateTime?   @map("reviewed_at")
  createdAt          DateTime    @default(now()) @map("created_at")

  transaction        Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  adminUser          AdminUser?  @relation(fields: [reviewedBy], references: [id])

  @@map("payment_verifications")
}

// Loan Management
model Loan {
  id              String    @id @default(cuid())
  userId          String    @map("user_id")
  accountId       String    @map("account_id") // Disbursal/Repayment account
  amount          Decimal
  currency        String    @default("USD")
  interestRate    Decimal   @map("interest_rate")
  termMonths      Int       @map("term_months")
  startDate       DateTime  @map("start_date")
  endDate         DateTime  @map("end_date")
  status          String    @default("PENDING") // PENDING, ACTIVE, PAID, DEFAULTED
  remainingAmount Decimal   @map("remaining_amount")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  account         Account   @relation(fields: [accountId], references: [id])
  repayments      LoanRepayment[]

  @@map("loans")
}

model LoanRepayment {
  id              String    @id @default(cuid())
  loanId          String    @map("loan_id")
  amount          Decimal
  currency        String    @default("USD")
  status          String    @default("COMPLETED")
  transactionId   String?   @unique @map("transaction_id") // Link to actual transaction
  paidAt          DateTime  @default(now()) @map("paid_at")

  loan            Loan      @relation(fields: [loanId], references: [id], onDelete: Cascade)

  @@map("loan_repayments")
}
